---
name: Blog post
layout: layout.eta
---

<main>
<article class="h-entry">
<header class="entry-page-header">
<h1 class="p-name links">The Implementation of HDB, the _hyperscript debugger</h1>
<metadata-block>
<p>
<a class="p-author h-card" href="/">Deniz Akşimşek</a> &mdash;
<a href="/2021/the-implementation-of-hdb/" class="entry-u-url u-url"><time class="dt-published" datetime="2021-03-17T00:00:00.000+03:00">2021-03-17 00:00</time></a>
<p>Last modified
<time class="dt-updated" datetime="2022-02-16T21:19:17.072+03:00">2022-02-16 21:19</time></p>
<p class="syndication">also on
<a class="u-syndication" href="https://twitter.com/DenizAksimsek/status/1372244813928660993">Twitter</a>,
<a class="u-syndication" href="https://news.ycombinator.com/item?id&#x3D;26494553">Hacker News</a> and
<a class="u-syndication" href="https://dev.to/dz4k/the-implementation-of-hdb-the-hyperscript-debugger-5hf4">DEV</a></p>
</metadata-block>
</header>
<div class="e-content"><script src="/assets/js/core.js"></script>
<script src="/assets/js/web.js"></script>
<script src="/assets/js/hdb.js"></script>
<p><strong>Update <time>2021-09-02</time>:</strong> HDB has evolved since this post was written. Though it works mostly the same way, there have been fixes and a UI redesign. Check <a href="https://github.com/bigskysoftware/_hyperscript">the _hyperscript repo</a> for the up-to-date code.</ins></p>
<p>The 0.0.6 release of the <a href="https://hyperscript.org">_hyperscript</a> hypertext UI scripting language introduces HDB, an interactive debugging environment. In this article I discuss how the hyper-flexible hyperscript runtime allowed me to implement the first release of HDB with ease. But first, I will introduce you to what HDB is like:</p>
<h2>The (Un)finished Product</h2>
<p>The <code>breakpoint</code> statement stops execution and launches the HDB UI.</p>
<figure><figcaption>Demo: The breakpoint command</figcaption>
<p><button type="button" _="
on click
	breakpoint
	-- This is some sample code for you to explore HDB.
	-- Click 'Step Over' to move to the next command.
	-- Click 'Continue' to stop debugging.
	set my.innerHTML to 'You are stepping through!'
	transition 'background-color' to red
	wait for mouseover -- mouse over the button after you step over this
	transition 'background-color' to initial
">Click me to try HDB</button></p>
</figure>
<p>You can set breakpoints conditionally:</p>
<figure><figcaption>Demo: Conditional breakpoints</figcaption>
<p><label><input type=checkbox id=debugmode checked /> Debug Mode</label>
<button type="button" _="
on click
	if #debugmode.checked breakpoint end
	put 'Nothing to see here, end user' into me
">Debug, maybe</button></p>
</figure>
<h2>Implementation</h2>
<p>HDB lives in a <a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js">single JavaScript file</a>.</p>
<h3>Turning the keys</h3>
<p>In the hyperscript runtime, <span><small>(The runtime is an example of a tree walking interpreter.)</small></span> each command has an <code>execute()</code> method which either returns the next command to be executed, or a <code>Promise</code> thereof. The execute method for the breakpoint command creates an HDB environment and assigns it to the global scope (usually <code>window</code>):</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L20">hdb.js ln. 20</a></figcaption>
<pre class="language-js"><code class="highlighted language-js"><span class="token keyword">var</span> hdb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HDB</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> runtime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>window<span class="token punctuation">.</span>hdb <span class="token operator">=</span> hdb<span class="token punctuation">;</span></code></pre>
</figure>
<p>The <code>HDB</code> object keeps hold of the current command and context as we step through. (The context is the object holding the local variables for the hyperscript code, and some other things the runtime keeps track of). We call its <code>break()</code> method:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L35">hdb.js ln. 35</a></figcaption>
<pre class="language-js"><code class="highlighted language-js"><span class="token class-name">HDB</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">break</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"%c=== HDB///_hyperscript/debugger ==="</span><span class="token punctuation">,</span> headingStyle<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	self<span class="token punctuation">.</span><span class="token function">ui</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		self<span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"continue"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>ctx <span class="token operator">!==</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>				<span class="token comment">// Context switch</span><br>				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> attr <span class="token keyword">in</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>					<span class="token keyword">delete</span> ctx<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">;</span><br>				<span class="token punctuation">}</span><br>				Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span><br>			<span class="token punctuation">}</span><br>			<span class="token keyword">delete</span> window<span class="token punctuation">.</span>hdb<span class="token punctuation">;</span><br>			<span class="token function">resolve</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">findNext</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cmd<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> once<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
</figure>
<p>There are a few things to unpack here. We call <code>self.ui()</code> to start the UI, which we’ll get to later. Remember how a command can return the next method to execute as a promise? The break method resolves after the <a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L10">internal event bus</a> receives a <code>&quot;continue&quot;</code> event, whether by the user pressing “Continue” or simply reaching the end of the debugged code.</p>
<p>The “context switch” is the dirtiest part of it all. Because we can step out of functions, we might finish debugging session with a different context than before. In this case, we just wipe the old context and copy the current context variables over. Honestly, I thought I’d have to do a lot more of this kind of thing.</p>
<p>Speaking of stepping out of functions…</p>
<h3>Stepping Over and Out</h3>
<p>Firstly, if self.cmd is null, then the previous command was the last one, so we just stop the debug process:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L58">hdb.js ln. 58</a></figcaption>
<pre class="language-js"><code class="highlighted language-js"><span class="token class-name">HDB</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">stepOver</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>self<span class="token punctuation">.</span>cmd<span class="token punctuation">)</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">continueExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</figure>
<p>If not, then we do a little dance to execute the current command and get the next one:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L61">hdb.js ln. 61</a></figcaption>
<pre class="language-js"><code class="highlighted language-js"><span class="token keyword">var</span> result <span class="token operator">=</span> self<span class="token punctuation">.</span>cmd <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'breakpointCommand'</span> <span class="token operator">?</span><br>	self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">findNext</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cmd<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span> <span class="token operator">:</span><br>	self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">unifiedEval</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cmd<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</figure>
<p>We perform a useless check that I forgot to take out (<code>self.cmd &amp;&amp;</code>). Then, we special-case the <code>breakpoint</code> command itself and don’t execute it (nested debug sessions don’t end well…), instead finding the subsequent command ourselves with the <code>runtime.findNext()</code> in hyperscript core. Otherwise, we can execute the current command.</p>
<p>Once we have our command result, we can step onto it:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L61">hdb.js ln. 64</a></figcaption>
<pre class="language-js"><code class="highlighted language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"implicitReturn"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">stepOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>then <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		self<span class="token punctuation">.</span>cmd <span class="token operator">=</span> next<span class="token punctuation">;</span><br>		self<span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"step"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		self<span class="token punctuation">.</span><span class="token function">logCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>halt_flag<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">this</span><span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"continue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>	self<span class="token punctuation">.</span>cmd <span class="token operator">=</span> result<span class="token punctuation">;</span><br>	self<span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"step"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">logCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</figure>
<p>If we returned from a function, we step out of it (discussed below). Otherwise, if the command returned a Promise, we await the next command, set <code>cmd</code> to it, notify the event bus and log it with some fancy styles. If the result was synchronous and is a <a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/core.js#L1221">HALT</a>; we stop debugging (as I write this, I’m realizing I should’ve called <a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L54"><code>continueExec()</code></a> here). Finally, we commit the kind of code duplication hyperscript is meant to help you avoid, to handle a synchronous result.</p>
<p>To step out, we first get our hands on the context from which we were called:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L80">hdb.js ln. 80</a></figcaption>
<pre class="language-js"><code class="highlighted language-js"><span class="token class-name">HDB</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">stepOut</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>caller<span class="token punctuation">)</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">continueExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">var</span> callingCmd <span class="token operator">=</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>callingCommand<span class="token punctuation">;</span><br>	<span class="token keyword">var</span> oldMe <span class="token operator">=</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>me<span class="token punctuation">;</span><br>	self<span class="token punctuation">.</span>ctx <span class="token operator">=</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>caller<span class="token punctuation">;</span></code></pre>
</figure>
<p>Turns out _hyperscript function calls already keep hold of the caller context (<code>callingCommand</code> was added by me though). After we change context, we do something a little odd:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L92">hdb.js ln. 92	</a></figcaption>
<pre class="language-js"><code class="highlighted language-js">self<span class="token punctuation">.</span>cmd <span class="token operator">=</span> self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">findNext</span><span class="token punctuation">(</span>callingCmd<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span><br>self<span class="token punctuation">.</span>cmd <span class="token operator">=</span> self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">findNext</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cmd<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</figure>
<p>Why do we call <code>findNext</code> twice? Consider the following hyperscript code:</p>
<pre class="language-hyperscript"><code class="highlighted language-hyperscript"><span class="token keyword"><span class="token hs-start bold">transition</span></span> <span class="token string">'color'</span> <span class="token keyword">to</span> darkgray<br><span class="token keyword"><span class="token hs-start bold">set</span></span> name <span class="token keyword">to</span> getName<span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword"><span class="token hs-start bold">log</span></span> <span class="token keyword">the</span> name</code></pre>
<p>We can’t execute the command to set <code>name</code> until we have the name, so when <code>getName()</code> is called, the current command is still set to the <code>transition</code>. We call <code>findNext</code> once to find the <code>set</code>, and again to find the <code>log</code>.</p>
<p>Finally, we’re done stepping out:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L95">hdb.js ln. 95</a></figcaption>
<pre class="language-js"><code class="highlighted language-js">self<span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">'step'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
</figure>
<h3>HDB UI</h3>
<p>What did I use to make the UI for the hyperscript debugger? Hyperscript, of course!</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L107">hdb.js ln. 107</a></figcaption>
<pre class="language-html"><code class="highlighted language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hdb<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">_</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value hyperscript language-hyperscript"><span class="token comment">--</span><br>	<span class="token keyword"><span class="token hs-start bold">on</span></span> load <span class="token keyword">or</span> step <span class="token keyword">from</span> hdb<span class="token operator">.</span>bus <span class="token keyword"><span class="token hs-start bold">send</span></span> update <span class="token keyword">to</span> <span class="token builtin">me</span><br>	<span class="token keyword"><span class="token hs-start bold">on</span></span> continue <span class="token keyword">from</span> hdb<span class="token operator">.</span>bus <span class="token keyword"><span class="token hs-start bold">remove</span></span> <span class="token id-ref selector">#hyperscript-hdb-ui-wrapper-</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span></code></pre>
</figure>
<p>There are a lot of elements listening to <code>load or step from hdb.bus</code>, so I consolidated them under <code>update from .hdb</code>. <code>#hyperscript-hdb-ui-wrapper-</code> is the element whose Shadow DOM this UI lives in — using shadow DOM to isolate the styling of the panel cost me later on, as you’ll see.</p>
<hr>
<p>We define some functions.</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L112">hdb.js ln. 112</a></figcaption>
<pre class="language-hyperscript"><code class="highlighted language-hyperscript"><span class="token keyword"><span class="token hs-start bold">def</span></span> highlightDebugCode<br>	<span class="token keyword"><span class="token hs-start bold">set</span></span> start <span class="token keyword">to</span> hdb<span class="token operator">.</span>cmd<span class="token operator">.</span>startToken<span class="token operator">.</span>start<br>	<span class="token keyword"><span class="token hs-start bold">set</span></span> end_ <span class="token keyword">to</span> hdb<span class="token operator">.</span>cmd<span class="token operator">.</span>endToken<span class="token operator">.</span><span class="token keyword"><span class="token hs-start bold">end</span></span><br>	<span class="token keyword"><span class="token hs-start bold">set</span></span> src <span class="token keyword">to</span> hdb<span class="token operator">.</span>cmd<span class="token operator">.</span>programSource<br>	<span class="token keyword"><span class="token hs-start bold">set</span></span> beforeCmd <span class="token keyword">to</span> escapeHTML<span class="token punctuation">(</span>src<span class="token operator">.</span>substring<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword"><span class="token hs-start bold">set</span></span> cmd <span class="token keyword">to</span> escapeHTML<span class="token punctuation">(</span>src<span class="token operator">.</span>substring<span class="token punctuation">(</span>start<span class="token punctuation">,</span> end_<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword"><span class="token hs-start bold">set</span></span> afterCmd <span class="token keyword">to</span> escapeHTML<span class="token punctuation">(</span>src<span class="token operator">.</span>substring<span class="token punctuation">(</span>end_<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword"><span class="token hs-start bold">return</span></span> beforeCmd<span class="token operator">+</span><span class="token string">"&lt;u class='current'>"</span><span class="token operator">+</span>cmd<span class="token operator">+</span><span class="token string">"&lt;/u>"</span><span class="token operator">+</span>afterCmd<br><span class="token keyword"><span class="token hs-start bold">end</span></span></code></pre>
</figure>
<p>Now, I wasn’t aware that we had <a href="https://hyperscript.org/expressions/string/">template literals</a> in hyperscript at this point, so that’s for the next release. The <code>escapeHTML</code> helper might disappoint some:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L122">hdb.js ln. 122</a></figcaption>
<pre class="language-hyperscript"><code class="highlighted language-hyperscript"><span class="token keyword"><span class="token hs-start bold">def</span></span> escapeHTML<span class="token punctuation">(</span>unsafe<span class="token punctuation">)</span><br>	<span class="token keyword"><span class="token hs-start bold">js</span></span><span class="token punctuation">(</span>unsafe<span class="token punctuation">)</span> <span class="token keyword"><span class="token hs-start bold">return</span></span> unsafe<br>	<span class="token class-ref selector">	.replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token punctuation">&amp;</span><span class="token operator">/</span>g<span class="token punctuation">,</span> <span class="token string">"&amp;amp;"</span><span class="token punctuation">)</span><br>	<span class="token class-ref selector">	.replace</span><span class="token punctuation">(</span><span class="token operator">/</span>&lt;<span class="token operator">/</span>g<span class="token punctuation">,</span> <span class="token string">"&amp;lt;"</span><span class="token punctuation">)</span><br>	<span class="token class-ref selector">	.replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">/</span>g<span class="token punctuation">,</span> <span class="token string">"&amp;gt;"</span><span class="token punctuation">)</span><br>	<span class="token class-ref selector">	.replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">\</span><span class="token operator">\</span>x<span class="token number">22</span><span class="token operator">/</span>g<span class="token punctuation">,</span> <span class="token string">"&amp;quot;"</span><span class="token punctuation">)</span><br>	<span class="token class-ref selector">	.replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">\</span><span class="token operator">\</span>x<span class="token number">27</span><span class="token operator">/</span>g<span class="token punctuation">,</span> <span class="token string">"&amp;#039;"</span><span class="token punctuation">)</span> <span class="token keyword"><span class="token hs-start bold">end</span></span><br>	<span class="token keyword"><span class="token hs-start bold">return</span></span> <span class="token builtin">it</span><br><span class="token keyword"><span class="token hs-start bold">end</span></span></code></pre>
</figure>
<p>Unfortunately, hyperscript’s regex syntax isn’t decided yet.</p>
<hr>
<p>And we have the most broken part of HDB, the prettyPrint function. If you know how to do this better, feel free to send a PR.</p>
<p>Having defined our functions we have a simple toolbar and then the <strong>eval panel</strong>:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L158">hdb.js ln. 158</a></figcaption>
<pre class="language-html"><code class="highlighted language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>eval-form<span class="token punctuation">"</span></span>  <span class="token special-attr"><span class="token attr-name">_</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value hyperscript language-hyperscript"><span class="token keyword"><span class="token hs-start bold">on</span></span> submit<br>	<span class="token keyword"><span class="token hs-start bold">call</span></span> <span class="token builtin">event</span><span class="token operator">.</span>preventDefault<span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token keyword"><span class="token hs-start bold">get</span></span> <span class="token keyword">the</span> <span class="token keyword">first</span> <span class="token selector">&lt;input/></span> <span class="token keyword">in</span> <span class="token builtin">me</span><br>	<span class="token keyword"><span class="token hs-start bold">call</span></span> _hyperscript<span class="token punctuation">(</span><span class="token builtin">its</span><span class="token operator">.</span>value<span class="token punctuation">,</span> hdb<span class="token operator">.</span>ctx<span class="token punctuation">)</span><br>	<span class="token keyword"><span class="token hs-start bold">call</span></span> prettyPrint<span class="token punctuation">(</span><span class="token builtin">it</span><span class="token punctuation">)</span><br>	<span class="token keyword"><span class="token hs-start bold">put</span></span> <span class="token builtin">it</span> <span class="token keyword">into</span> <span class="token keyword">the</span> <span class="token selector">&lt;output/></span> <span class="token keyword">in</span> <span class="token builtin">me</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><br><br>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>eval-expr<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>e.g. target.innerText<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Go<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>output</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>eval-output<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">></span></span>The value will show up here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>output</span><span class="token punctuation">></span></span></code></pre>
</figure>
<p>Why do I use weird selectors like <code>&lt;input/&gt; in me</code> when these elements have good IDs? Because <code>#eval-expr</code> in hyperscript uses <code>document.querySelector</code>, which doesn’t reach Shadow DOM.</p>
<hr>
<p>A panel to show the code being debugged:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L170">hdb.js ln. 170</a></figcaption>
<pre class="language-html"><code class="highlighted language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token special-attr"><span class="token attr-name">_</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value hyperscript language-hyperscript"><span class="token keyword"><span class="token hs-start bold">on</span></span> update <span class="token keyword">from</span> hdbUI<br>		<span class="token keyword"><span class="token hs-start bold">put</span></span> <span class="token string">'Debugging &lt;code>'</span><span class="token operator">+</span>hdb<span class="token operator">.</span>cmd<span class="token operator">.</span>parent<span class="token operator">.</span>displayName<span class="token operator">+</span><span class="token string">'&lt;/code>'</span> <span class="token keyword">into</span> <span class="token builtin">me</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code-container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">_</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value hyperscript language-hyperscript"><span class="token keyword"><span class="token hs-start bold">on</span></span> update <span class="token keyword">from</span> hdbUI<br>							<span class="token keyword"><span class="token hs-start bold">if</span></span> hdb<span class="token operator">.</span>cmd<span class="token operator">.</span>programSource<br>								<span class="token keyword"><span class="token hs-start bold">put</span></span> highlightDebugCode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">into</span> <span class="token builtin">my</span><span class="token operator">.</span>innerHTML<br>								scrollIntoView<span class="token punctuation">(</span><span class="token punctuation">{</span> block<span class="token punctuation">:</span> <span class="token string">'nearest'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">the</span><br>								<span class="token keyword">first</span><span class="token class-ref selector"> .current</span> <span class="token keyword">in</span> <span class="token builtin">me</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</figure>
<hr>
<p>Finally, a context panel that shows the local variables.</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L186">hdb.js ln. 106</a></figcaption>
<pre class="language-html"><code class="highlighted language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>context<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">_</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value hyperscript language-hyperscript"><span class="token comment">--</span><br>	<span class="token keyword"><span class="token hs-start bold">on</span></span> update <span class="token keyword">from</span> hdbUI<br>		<span class="token keyword"><span class="token hs-start bold">set</span></span> <span class="token builtin">my</span><span class="token operator">.</span>innerHTML <span class="token keyword">to</span> <span class="token string">''</span><br>		<span class="token keyword"><span class="token hs-start bold">repeat for</span></span> var <span class="token keyword">in</span> Object<span class="token operator">.</span>keys<span class="token punctuation">(</span>hdb<span class="token operator">.</span>ctx<span class="token punctuation">)</span> <span class="token keyword"><span class="token hs-start bold">if</span></span> var <span class="token operator">!=</span> <span class="token string">'meta'</span><br>			<span class="token keyword"><span class="token hs-start bold">get</span></span> <span class="token string">'&lt;dt>'</span><span class="token operator">+</span>var<span class="token operator">+</span><span class="token string">'&lt;dd>'</span><span class="token operator">+</span>prettyPrint<span class="token punctuation">(</span>hdb<span class="token operator">.</span>ctx<span class="token punctuation">[</span>var<span class="token punctuation">]</span><span class="token punctuation">)</span><br>			<span class="token keyword"><span class="token hs-start bold">put</span></span> <span class="token builtin">it</span> <span class="token keyword">at <span class="token hs-start bold">end</span> of</span> <span class="token builtin">me</span><br>		<span class="token keyword"><span class="token hs-start bold">end</span></span><br>	<span class="token keyword"><span class="token hs-start bold">on</span></span> click<br>		<span class="token keyword"><span class="token hs-start bold">get</span></span> <span class="token keyword">closest</span> <span class="token selector">&lt;dt/></span> <span class="token keyword">to</span> <span class="token builtin">target</span><br>		<span class="token keyword"><span class="token hs-start bold">log</span></span> hdb<span class="token operator">.</span>ctx<span class="token punctuation">[</span><span class="token builtin">its</span><span class="token operator">.</span>innerText<span class="token punctuation">]</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">></span></span></code></pre>
</figure>
<p>That loop could definitely be cleaner. You can see the hidden feature where you can click a variable name to log it to the console (useful if you don’t want to rely on my super-buggy pretty printer).</p>
<p>Some CSS later, we’re done with the UI! To avoid CSS interference from the host page, we create a wrapper and put our UI in its shadow DOM:</p>
<figure><figcaption><a href="https://github.com/bigskysoftware/_hyperscript/blob/7740c7eccfe3fe4f09443ec0adb961c72eb27a7b/src/lib/hdb.js#L350">hdb.js ln. 350</a></figcaption>
<pre class="language-js"><code class="highlighted language-js"><span class="token class-name">HDB</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">ui</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">var</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">var</span> shadow <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	node<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">'all: initial'</span><span class="token punctuation">;</span><br>	node<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'hyperscript-hdb-ui-wrapper-'</span><span class="token punctuation">;</span><br>	shadow<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> ui<span class="token punctuation">;</span><br>	document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	window<span class="token punctuation">.</span>hdbUI <span class="token operator">=</span> shadow<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.hdb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	_hyperscript<span class="token punctuation">.</span><span class="token function">processNode</span><span class="token punctuation">(</span>hdbUI<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</figure>
<h2>The End</h2>
<p>In just 360 lines, we have a basic debugger. This speaks volumes to the flexibility of the hyperscript runtime, and I hope HDB serves as an example of what’s possible with the hyperscript extension API. Like the rest of hyperscript, it’s in early stages of development — feedback and contributors are always welcome!</p>
</div>
<footer class="comments">
<section class="webmentions" id="webmentions">
<h2>Webmentions</h2>
<p class="-wide-para"><strong>Liked by:</strong>
<a href="https://twitter.com/DenizAksimsek/status/1372244813928660993#favorited-by-1851621">Aneesha Bakharia</a>
&middot;
<a href="https://twitter.com/DenizAksimsek/status/1372244813928660993#favorited-by-1273360999446269952">/srv/jacklinke/🪅</a>
&middot;
<a href="https://twitter.com/DenizAksimsek/status/1372244813928660993#favorited-by-1158841325195804677">Thomas Güttler</a>
&middot;
<a href="https://twitter.com/DenizAksimsek/status/1372244813928660993#favorited-by-301509267">Bill Talcott</a>
&middot;
<a href="https://twitter.com/DenizAksimsek/status/1372244813928660993#favorited-by-5614992">Eric Acevedo</a>
&middot;
<a href="https://twitter.com/DenizAksimsek/status/1372244813928660993#favorited-by-2601398665">Luke Fielke</a>
&middot;
<a href="https://twitter.com/DenizAksimsek/status/1372244813928660993#favorited-by-17715698">Camillo F</a>
&middot;
<a href="https://twitter.com/DenizAksimsek/status/1372244813928660993#favorited-by-1100791537863192576">Ricardo Ander-Egg</a>
</p>
</section>
</footer>
<footer class="entry-page-footer">
<section role="complementary">
<ul role=list class="flow-gap">
<li class="h-entry">&larr; <a href="/2021/contrast-black-and-white/">Colors That Contrast With Both Black And White</a>
<time class="dt-published">2021-03-05</time>
<li class="h-entry">&rarr; <a href="/2021/hypelet/">Hypelet</a>
<time class="dt-published">2021-05-01</time>
<li class="h-entry"> <a href="/2022/intentionally-unscalable/">Intentionally Unscalable</a>
<time class="dt-published">2022-02-06</time>
<li class="h-entry"> <a href="/2022/nanpa-pi-ken-ala-kipisi/">nanpa pi ken ala kipisi pi mute ale li lon</a>
<time class="dt-published">2022-01-14</time>
<li class="h-entry"> <a href="/2021/vstlbx/">VSCode/Toolbx</a>
<time class="dt-published">2021-11-17</time>
</ul>
</section>
</footer>
</article>
</main>
